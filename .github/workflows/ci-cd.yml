name: Red Wine Model CI/CD Pipeline

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: red_wine_predict_2022bcs0162

jobs:

  # ============================
  # JOB 1: TRAIN (CI)
  # ============================
  train:
    runs-on: ubuntu-latest

    outputs:
      r2: ${{ steps.metrics.outputs.r2 }}
      mse: ${{ steps.metrics.outputs.mse }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install Dependencies
        run: |
          pip install pandas scikit-learn joblib

      - name: Run Training Script
        run: python scripts/train.py

      - name: Extract Metrics
        id: metrics
        run: |
          R2=$(jq '.r2' outputs/metrics.json)
          MSE=$(jq '.mse' outputs/metrics.json)
          echo "r2=$R2" >> $GITHUB_OUTPUT
          echo "mse=$MSE" >> $GITHUB_OUTPUT

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts
          path: outputs/


  # ============================
  # JOB 2: DEPLOY (CD)
  # ============================
  deploy:
    needs: train
    runs-on: ubuntu-latest

    steps:

      - name: Compare Metrics
        id: compare
        run: |
          if (( $(echo "${{ needs.train.outputs.r2 }} > ${{ vars.BEST_R2 }}" | bc -l) )) && \
             (( $(echo "${{ needs.train.outputs.mse }} < ${{ vars.BEST_MSE }}" | bc -l) )); then
            echo "improved=true" >> $GITHUB_OUTPUT
          else
            echo "improved=false" >> $GITHUB_OUTPUT
          fi

      - name: Stop if Model Did Not Improve
        if: steps.compare.outputs.improved == 'false'
        run: echo "2022bcs0162 ---- Metric did not improve"

      - name: Checkout Repository
        if: steps.compare.outputs.improved == 'true'
        uses: actions/checkout@v4

      - name: Download Artifacts
        if: steps.compare.outputs.improved == 'true'
        uses: actions/download-artifact@v4
        with:
          name: model-artifacts
          path: .

      - name: Move Model and Scaler
        if: steps.compare.outputs.improved == 'true'
        run: |
          mv model.pkl app/model.pkl
          mv scaler.pkl app/scaler.pkl

      - name: Login to Docker Hub
        if: steps.compare.outputs.improved == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build Docker Image with Auto Version
        if: steps.compare.outputs.improved == 'true'
        run: |
          VERSION=v${{ github.run_number }}
          echo "Deploying version: $VERSION"

          docker build \
            -t ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:$VERSION \
            -t ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest \
            ./app

          docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:$VERSION
          docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest

      - name: Update Best Metrics
        if: steps.compare.outputs.improved == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh variable set BEST_R2 --body "${{ needs.train.outputs.r2 }}"
          gh variable set BEST_MSE --body "${{ needs.train.outputs.mse }}"